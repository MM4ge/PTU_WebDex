package org.allenfulmer.ptuviewer.jsonExport;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import org.allenfulmer.ptuviewer.generator.Pokemon;
import org.allenfulmer.ptuviewer.generator.models.Nature;
import org.allenfulmer.ptuviewer.jsonExport.exodus.PokemonExodus;
import org.allenfulmer.ptuviewer.jsonExport.exodus.StatExodus;
import org.allenfulmer.ptuviewer.jsonExport.roll20.PokemonRoll20;
import org.allenfulmer.ptuviewer.jsonLoading.PojoToDBConverter;
import org.allenfulmer.ptuviewer.models.PokemonSpecies;
import org.allenfulmer.ptuviewer.models.Stat;

import java.util.EnumMap;
import java.util.List;
import java.util.Map;
import java.util.Scanner;
import java.util.stream.Collectors;

public class ExodusConverter {

    private static final Gson gson = new GsonBuilder().serializeNulls().disableHtmlEscaping().setLenient().create();

    private ExodusConverter(){}

    public static void main(String[] args)
    {
        Scanner input = new Scanner(System.in);
        System.out.println("Input the exodusJSON (un-beautified - as one line), then hit Enter:");
        String exodusJSON = input.nextLine();
//        String exodusJSON = "{\"notes\":[{\"title\":\"New Note\",\"body\":\"\"}],\"pokemonDocumentId\":\"9fc12b88-5645-4e4a-9853-5ac78c3eb6ae\",\"googleDriveFileId\":null,\"googleDriveFolderId\":\"\",\"fileName\":\"\",\"pokedexEntry\":{\"capabilities\":{\"Sky\":null,\"Overland\":5,\"Levitate\":null,\"High Jump\":1,\"Long Jump\":1,\"Burrow\":2,\"Naturewalk (Grassland)\":-1,\"Power\":2,\"Underdog\":-1,\"Swim\":3},\"otherCapabilities\":\"Naturewalk (Grassland),Underdog\",\"pokedexEntryDocumentId\":null,\"pokedexDocumentId\":null,\"species\":\"Nidoran♀\",\"form\":\"\",\"types\":[\"Poison\"],\"legendary\":false,\"nationalDexNumber\":null,\"regionOfOrigin\":null,\"entryText\":null,\"imageFileUrl\":\"029.png\",\"cryFileUrl\":null,\"baseStats\":{},\"size\":\"1' 4\" / 0.4m (Small)\",\"weight\":\"15.4 lbs. / 7kg (1)\",\"genderless\":true,\"malePercent\":null,\"femalePercent\":null,\"eggGroups\":[\"Monster\",\"Field\"],\"hatchRate\":null,\"habitats\":[],\"diets\":[],\"moveLearnset\":{\"levelUpMoves\":[{\"moveName\":\"Helping Hand\",\"learnedLevel\":25},{\"moveName\":\"Tail Whip\",\"learnedLevel\":7},{\"moveName\":\"Flatter\",\"learnedLevel\":33},{\"moveName\":\"Captivate\",\"learnedLevel\":43},{\"moveName\":\"Double Kick\",\"learnedLevel\":9},{\"moveName\":\"Growl\",\"learnedLevel\":1},{\"moveName\":\"Bite\",\"learnedLevel\":21},{\"moveName\":\"Fury Swipes\",\"learnedLevel\":19},{\"moveName\":\"Scratch\",\"learnedLevel\":1},{\"moveName\":\"Poison Sting\",\"learnedLevel\":13},{\"moveName\":\"Poison Fang\",\"learnedLevel\":45},{\"moveName\":\"Toxic Spikes\",\"learnedLevel\":31},{\"moveName\":\"Crunch\",\"learnedLevel\":37}],\"machineMoves\":[\"Cut\",\"Strength\",\"Hone Claws\",\"Toxic\",\"Venoshock\",\"Hidden Power\",\"Sunny Day\",\"Ice Beam\",\"Blizzard\",\"Protect\",\"Rain Dance\",\"Frustration\",\"Thunderbolt\",\"Thunder\",\"Return\",\"Dig\",\"Double Team\",\"Sludge Bomb\",\"Aerial Ace\",\"Facade\",\"Rest\",\"Attract\",\"Thief\",\"Round\",\"Shadow Claw\",\"Poison Jab\",\"Swagger\",\"Sleep Talk\",\"Substitute\",\"Rock Smash\"],\"eggMoves\":[\"Beat Up\",\"Charm\",\"Chip Away\",\"Counter\",\"Disable\",\"Endure\",\"Focus Energy\",\"Iron Tail\",\"Poison Tail\",\"Pursuit\",\"Supersonic\",\"Take Down\",\"Venom Drench\"],\"tutorMoves\":[\"Body Slam\",\"Defense Curl\",\"Double-Edge\",\"Helping Hand\",\"Iron Tail\",\"Mud-Slap\",\"Shock Wave\",\"Sleep Talk\",\"Snore\",\"Super Fang\",\"Water Pulse\"]},\"abilityLearnset\":{\"basicAbilities\":[{\"name\":\"Poison Point\",\"effect\":\"The user may reroll any roll, or have any ally reroll any roll that has been made. This leaves discoverable Psychic residue.\",\"trigger\":\"\",\"target\":\"Any roll made by yourself or an ally.\",\"frequency\":\"Scene - Free Action\"},{\"name\":\"Rivalry\",\"effect\":\"Whenever the user deals direct damage to a target of the same gender, increase the Damage dealt by +5.\",\"trigger\":\"\",\"target\":\"\",\"frequency\":\"Static\"}],\"advancedAbilities\":[{\"name\":\"Celebrate\",\"effect\":\"The user may immediately Disengage as a Free Action. Bonus: Whenever the user Disengages for any reason, they may Shift 2 meters instead of 1.\",\"trigger\":\"The user hits a foe with a damaging attack\",\"target\":\"\",\"frequency\":\"At-Will - Swift Action\"},{\"name\":\"Hustle\",\"effect\":\"The user receives a -2 penalty to all Accuracy Rolls and gains a +10 Bonus to All Damage Rolls.\",\"trigger\":\"\",\"target\":\"\",\"frequency\":\"Static\"}],\"highAbilities\":[{\"name\":\"Bodyguard\",\"effect\":\"The user and the target switch places, and the user becomes the target of the attack instead, taking damage from the attack as if resisted one step further. If switching places would not move the triggering Ally out of the area-of-effect of a Burst, Blast, Cone, or Line, this Ability does not prevent the ally from being hit. Defensive.\",\"trigger\":\"A cardinally adjacent Ally is hit by an attack\",\"target\":\"\",\"frequency\":\"Scene – Free Action\"}]},\"skills\":{\"survival\":\"\",\"focus\":\"2d6+0\",\"combat\":\"3d6+0\",\"command\":\"\",\"acrobatics\":\"2d6+0\",\"perception\":\"2d6+0\",\"techEdu\":\"0d6+0\",\"intimidate\":\"\",\"occultEdu\":\"\",\"pokemonEdu\":\"\",\"charm\":\"\",\"guile\":\"\",\"stealth\":\"3d6+1\",\"generalEdu\":\"\",\"athletics\":\"2d6+1\",\"intuition\":\"\",\"medicineEdu\":\"\"},\"evolutionFamily\":{\"familyName\":null,\"entries\":[]},\"evolutionStage\":null,\"evolutionsRemainingMale\":null,\"evolutionsRemainingFemale\":null,\"evolutionsRemainingGenderless\":null,\"evolutionMinLevel\":0,\"evolutionAtLevel\":100,\"megaEvolution\":null,\"levelUpMoves\":{},\"basicAbilities\":[],\"advancedAbilities\":[],\"highAbilities\":[]},\"name\":\"Nidoran♀\",\"level\":32,\"exp\":1355,\"nature\":\"Bold\",\"gender\":\"Female\",\"shiny\":false,\"hp\":{\"base\":6,\"lvlUp\":7,\"add\":0,\"cs\":0,\"sum\":13},\"atk\":{\"base\":3,\"lvlUp\":5,\"add\":0,\"cs\":0,\"sum\":8},\"def\":{\"base\":7,\"lvlUp\":10,\"add\":0,\"cs\":0,\"sum\":17},\"spatk\":{\"base\":4,\"lvlUp\":7,\"add\":0,\"cs\":0,\"sum\":11},\"spdef\":{\"base\":4,\"lvlUp\":7,\"add\":0,\"cs\":0,\"sum\":11},\"spd\":{\"base\":4,\"lvlUp\":6,\"add\":0,\"cs\":0,\"sum\":10},\"health\":null,\"injuries\":0,\"thp\":0,\"dr\":0,\"afflictions\":null,\"buffs\":\"\",\"evasionPhysicalBonus\":0,\"evasionSpecialBonus\":0,\"evasionSpeedBonus\":0,\"heldItem\":null,\"moves\":[{\"name\":\"Double Kick\",\"type\":\"Fighting\",\"stab\":false,\"frequency\":\"At-Will\",\"accuracyCheck\":3,\"damageBase\":3,\"damageClass\":\"Physical\",\"range\":\"Melee, 1 Target, Double Strike\",\"effects\":\"\",\"contestType\":\"Cool\",\"contestEffect\":\"Reliable\",\"critsOn\":\"\"},{\"name\":\"Bite\",\"type\":\"Dark\",\"stab\":false,\"frequency\":\"At-Will\",\"accuracyCheck\":2,\"damageBase\":6,\"damageClass\":\"Physical\",\"range\":\"Melee, 1 Target\",\"effects\":\"Bite Flinches the target on 15+.\",\"contestType\":\"Tough\",\"contestEffect\":\"Steady Performance\",\"critsOn\":\"\"},{\"name\":\"Growl\",\"type\":\"Normal\",\"stab\":false,\"frequency\":\"At-Will\",\"accuracyCheck\":2,\"damageBase\":null,\"damageClass\":\"Status\",\"range\":\"Burst 1, Friendly, Sonic, Social\",\"effects\":\"Lower the Attack of all legal targets by -1 CS.\",\"contestType\":\"Cute\",\"contestEffect\":\"Excitement\",\"critsOn\":\"\"},{\"name\":\"Toxic Spikes\",\"type\":\"Poison\",\"stab\":true,\"frequency\":\"EOT\",\"accuracyCheck\":null,\"damageBase\":null,\"damageClass\":\"Status\",\"range\":\"6, Hazard\",\"effects\":\"Set 8 square meters of Toxic Spikes within the range such that all 8 meters are adjacent with at least one other space of Toxic Spikes. Toxic Spikes cause Terrain to become Slow Terrain, and a grounded foe that runs into the hazard becomes Poisoned and Slowed until the end of their next turn. If there are 2 layers of Toxic Spikes on the same space, it Badly Poisons the foes instead. Poison-Type Pokémon may move over Toxic Spikes harmlessly, destroying the Hazards as they do so.\",\"contestType\":\"Smart\",\"contestEffect\":\"Sabotage\",\"critsOn\":\"\"},{\"name\":\"Tail Whip\",\"type\":\"Normal\",\"stab\":false,\"frequency\":\"At-Will\",\"accuracyCheck\":2,\"damageBase\":null,\"damageClass\":\"Status\",\"range\":\"Burst 1, Friendly\",\"effects\":\"All legal targets have their Defense lowered by -1 CS.\",\"contestType\":\"Cute\",\"contestEffect\":\"Excitement\",\"critsOn\":\"\"},{\"name\":\"Fury Swipes\",\"type\":\"Normal\",\"stab\":false,\"frequency\":\"EOT\",\"accuracyCheck\":5,\"damageBase\":3,\"damageClass\":\"Physical\",\"range\":\"Melee, 1 Target, Five Strike\",\"effects\":\"\",\"contestType\":\"Tough\",\"contestEffect\":\"Reliable\",\"critsOn\":\"\"}],\"abilities\":[{\"name\":\"Rivalry\",\"effect\":\"Whenever the user deals direct damage to a target of the same gender, increase the Damage dealt by +5.\",\"trigger\":\"\",\"target\":\"\",\"frequency\":\"Static\"},{\"name\":\"Poison Point\",\"effect\":\"The user may reroll any roll, or have any ally reroll any roll that has been made. This leaves discoverable Psychic residue.\",\"trigger\":\"\",\"target\":\"Any roll made by yourself or an ally.\",\"frequency\":\"Scene - Free Action\"}],\"pokeEdges\":[],\"tutorPoints\":7,\"evolutionsRemaining\":2}";
//        String taco = {"notes":[{"title":"New Note","body":""}],"pokemonDocumentId":"9fc12b88-5645-4e4a-9853-5ac78c3eb6ae","googleDriveFileId":null,"googleDriveFolderId":"","fileName":"","pokedexEntry":{"capabilities":{"Sky":null,"Overland":5,"Levitate":null,"High Jump":1,"Long Jump":1,"Burrow":2,"Naturewalk (Grassland)":-1,"Power":2,"Underdog":-1,"Swim":3},"otherCapabilities":"Naturewalk (Grassland),Underdog","pokedexEntryDocumentId":null,"pokedexDocumentId":null,"species":"Nidoran♀","form":"","types":["Poison"],"legendary":false,"nationalDexNumber":null,"regionOfOrigin":null,"entryText":null,"imageFileUrl":"029.png","cryFileUrl":null,"baseStats":{},"size":"1' 4\" / 0.4m (Small)","weight":"15.4 lbs. / 7kg (1)","genderless":true,"malePercent":null,"femalePercent":null,"eggGroups":["Monster","Field"],"hatchRate":null,"habitats":[],"diets":[],"moveLearnset":{"levelUpMoves":[{"moveName":"Helping Hand","learnedLevel":25},{"moveName":"Tail Whip","learnedLevel":7},{"moveName":"Flatter","learnedLevel":33},{"moveName":"Captivate","learnedLevel":43},{"moveName":"Double Kick","learnedLevel":9},{"moveName":"Growl","learnedLevel":1},{"moveName":"Bite","learnedLevel":21},{"moveName":"Fury Swipes","learnedLevel":19},{"moveName":"Scratch","learnedLevel":1},{"moveName":"Poison Sting","learnedLevel":13},{"moveName":"Poison Fang","learnedLevel":45},{"moveName":"Toxic Spikes","learnedLevel":31},{"moveName":"Crunch","learnedLevel":37}],"machineMoves":["Cut","Strength","Hone Claws","Toxic","Venoshock","Hidden Power","Sunny Day","Ice Beam","Blizzard","Protect","Rain Dance","Frustration","Thunderbolt","Thunder","Return","Dig","Double Team","Sludge Bomb","Aerial Ace","Facade","Rest","Attract","Thief","Round","Shadow Claw","Poison Jab","Swagger","Sleep Talk","Substitute","Rock Smash"],"eggMoves":["Beat Up","Charm","Chip Away","Counter","Disable","Endure","Focus Energy","Iron Tail","Poison Tail","Pursuit","Supersonic","Take Down","Venom Drench"],"tutorMoves":["Body Slam","Defense Curl","Double-Edge","Helping Hand","Iron Tail","Mud-Slap","Shock Wave","Sleep Talk","Snore","Super Fang","Water Pulse"]},"abilityLearnset":{"basicAbilities":[{"name":"Poison Point","effect":"The user may reroll any roll, or have any ally reroll any roll that has been made. This leaves discoverable Psychic residue.","trigger":"","target":"Any roll made by yourself or an ally.","frequency":"Scene - Free Action"},{"name":"Rivalry","effect":"Whenever the user deals direct damage to a target of the same gender, increase the Damage dealt by +5.","trigger":"","target":"","frequency":"Static"}],"advancedAbilities":[{"name":"Celebrate","effect":"The user may immediately Disengage as a Free Action. Bonus: Whenever the user Disengages for any reason, they may Shift 2 meters instead of 1.","trigger":"The user hits a foe with a damaging attack","target":"","frequency":"At-Will - Swift Action"},{"name":"Hustle","effect":"The user receives a -2 penalty to all Accuracy Rolls and gains a +10 Bonus to All Damage Rolls.","trigger":"","target":"","frequency":"Static"}],"highAbilities":[{"name":"Bodyguard","effect":"The user and the target switch places, and the user becomes the target of the attack instead, taking damage from the attack as if resisted one step further. If switching places would not move the triggering Ally out of the area-of-effect of a Burst, Blast, Cone, or Line, this Ability does not prevent the ally from being hit. Defensive.","trigger":"A cardinally adjacent Ally is hit by an attack","target":"","frequency":"Scene – Free Action"}]},"skills":{"survival":"","focus":"2d6+0","combat":"3d6+0","command":"","acrobatics":"2d6+0","perception":"2d6+0","techEdu":"0d6+0","intimidate":"","occultEdu":"","pokemonEdu":"","charm":"","guile":"","stealth":"3d6+1","generalEdu":"","athletics":"2d6+1","intuition":"","medicineEdu":""},"evolutionFamily":{"familyName":null,"entries":[]},"evolutionStage":null,"evolutionsRemainingMale":null,"evolutionsRemainingFemale":null,"evolutionsRemainingGenderless":null,"evolutionMinLevel":0,"evolutionAtLevel":100,"megaEvolution":null,"levelUpMoves":{},"basicAbilities":[],"advancedAbilities":[],"highAbilities":[]},"name":"Nidoran♀","level":32,"exp":1355,"nature":"Bold","gender":"Female","shiny":false,"hp":{"base":6,"lvlUp":7,"add":0,"cs":0,"sum":13},"atk":{"base":3,"lvlUp":5,"add":0,"cs":0,"sum":8},"def":{"base":7,"lvlUp":10,"add":0,"cs":0,"sum":17},"spatk":{"base":4,"lvlUp":7,"add":0,"cs":0,"sum":11},"spdef":{"base":4,"lvlUp":7,"add":0,"cs":0,"sum":11},"spd":{"base":4,"lvlUp":6,"add":0,"cs":0,"sum":10},"health":null,"injuries":0,"thp":0,"dr":0,"afflictions":null,"buffs":"","evasionPhysicalBonus":0,"evasionSpecialBonus":0,"evasionSpeedBonus":0,"heldItem":null,"moves":[{"name":"Double Kick","type":"Fighting","stab":false,"frequency":"At-Will","accuracyCheck":3,"damageBase":3,"damageClass":"Physical","range":"Melee, 1 Target, Double Strike","effects":"","contestType":"Cool","contestEffect":"Reliable","critsOn":""},{"name":"Bite","type":"Dark","stab":false,"frequency":"At-Will","accuracyCheck":2,"damageBase":6,"damageClass":"Physical","range":"Melee, 1 Target","effects":"Bite Flinches the target on 15+.","contestType":"Tough","contestEffect":"Steady Performance","critsOn":""},{"name":"Growl","type":"Normal","stab":false,"frequency":"At-Will","accuracyCheck":2,"damageBase":null,"damageClass":"Status","range":"Burst 1, Friendly, Sonic, Social","effects":"Lower the Attack of all legal targets by -1 CS.","contestType":"Cute","contestEffect":"Excitement","critsOn":""},{"name":"Toxic Spikes","type":"Poison","stab":true,"frequency":"EOT","accuracyCheck":null,"damageBase":null,"damageClass":"Status","range":"6, Hazard","effects":"Set 8 square meters of Toxic Spikes within the range such that all 8 meters are adjacent with at least one other space of Toxic Spikes. Toxic Spikes cause Terrain to become Slow Terrain, and a grounded foe that runs into the hazard becomes Poisoned and Slowed until the end of their next turn. If there are 2 layers of Toxic Spikes on the same space, it Badly Poisons the foes instead. Poison-Type Pokémon may move over Toxic Spikes harmlessly, destroying the Hazards as they do so.","contestType":"Smart","contestEffect":"Sabotage","critsOn":""},{"name":"Tail Whip","type":"Normal","stab":false,"frequency":"At-Will","accuracyCheck":2,"damageBase":null,"damageClass":"Status","range":"Burst 1, Friendly","effects":"All legal targets have their Defense lowered by -1 CS.","contestType":"Cute","contestEffect":"Excitement","critsOn":""},{"name":"Fury Swipes","type":"Normal","stab":false,"frequency":"EOT","accuracyCheck":5,"damageBase":3,"damageClass":"Physical","range":"Melee, 1 Target, Five Strike","effects":"","contestType":"Tough","contestEffect":"Reliable","critsOn":""}],"abilities":[{"name":"Rivalry","effect":"Whenever the user deals direct damage to a target of the same gender, increase the Damage dealt by +5.","trigger":"","target":"","frequency":"Static"},{"name":"Poison Point","effect":"The user may reroll any roll, or have any ally reroll any roll that has been made. This leaves discoverable Psychic residue.","trigger":"","target":"Any roll made by yourself or an ally.","frequency":"Scene - Free Action"}],"pokeEdges":[],"tutorPoints":7,"evolutionsRemaining":2};
        Pokemon p1 = convertFromExodus(exodusJSON);
        System.out.println(gson.toJson(new PokemonRoll20(p1)));
    }

    public static Pokemon convertFromExodus(String exodusJSON)
    {
        PokemonExodus e1 = gson.fromJson(exodusJSON, PokemonExodus.class);
        Pokemon p1 = new Pokemon();

        //TODO: Catch for meowstic (and nidorans?) one has the bonus on name, the other on form

        Map<String, PokemonSpecies> allPokes = PojoToDBConverter.getConvertedPokemonSpeciesMap();
        List<PokemonSpecies> speciesMatches = allPokes.values().stream()
                .filter(p -> p.getSpeciesName().equalsIgnoreCase(e1.getPokedexEntry().getSpecies()))
                .filter(p -> p.getForm().toUpperCase().startsWith(e1.getPokedexEntry().getForm().toUpperCase()))
                .collect(Collectors.toList());

        if(speciesMatches.isEmpty())
            return null;
        else if (speciesMatches.size() > 1)
            throw new RuntimeException("Exodus Pokemon matched more than one DB Species!");
        p1.setSpecies(speciesMatches.get(0));

        Map<Stat.StatName, StatExodus> exodusStats = new EnumMap<>(Stat.StatName.class);
        exodusStats.put(Stat.StatName.HP, e1.getHp());
        exodusStats.put(Stat.StatName.ATTACK, e1.getAtk());
        exodusStats.put(Stat.StatName.DEFENSE, e1.getDef());
        exodusStats.put(Stat.StatName.SPECIAL_ATTACK, e1.getSpatk());
        exodusStats.put(Stat.StatName.SPECIAL_DEFENSE, e1.getSpdef());
        exodusStats.put(Stat.StatName.SPEED, e1.getSpd());
        p1.setStats(exodusStats.entrySet().stream().collect(Collectors.toMap(Map.Entry::getKey,
                e -> new Stat(e.getKey(), e.getValue().getBase(), 0, e.getValue().getLvlUp(), e.getValue().getAdd())
        )));

        p1.setNatureAndStats(Nature.getNature(e1.getNature()));
        p1.setGender(e1.getGender());
        p1.setLevel(e1.getLevel());
        p1.setMoves(e1.getMoves().stream().map(m -> PojoToDBConverter.getMove(m.getName())).collect(Collectors.toList()));
        p1.setAbilities(e1.getAbilities().stream().map(a -> PojoToDBConverter.getAbility(a.getName())).collect(Collectors.toSet()));

        return p1;
    }
}
